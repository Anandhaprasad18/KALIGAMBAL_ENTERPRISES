<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SRI KALIGAMBAL Quotation Generator</title>
    
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- PDF Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <style>
        .monospace {
            font-family: 'Courier New', monospace;
        }
        input[type=number]::-webkit-inner-spin-button,
        input[type=number]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
    </style>
</head>

<body class="bg-gray-100 p-4 md:p-8 min-h-screen font-sans">

<div class="max-w-4xl mx-auto bg-white shadow-2xl rounded-xl p-6 md:p-10 user-interface">

    <header class="text-center mb-8">
        <h1 class="text-3xl md:text-4xl font-extrabold text-blue-800">
            SRI KALIGAMBAL ENTERPRISES
        </h1>
        <p class="text-xl text-gray-600 mt-2">Quotation & Area Calculator</p>
    </header>

    <div id="detailsInput" class="bg-blue-50 p-4 rounded-lg mb-6 border border-blue-200">
        <h3 class="text-lg font-semibold text-blue-800 mb-3">Quotation Details</h3>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">

            <div class="p-3 bg-white rounded shadow-sm border border-blue-100">
                <p class="font-bold text-sm mb-1 text-gray-600">Company Contact</p>
                <input type="text" id="companyName" value="SRI KALIGAMBAL ENTERPRISES" class="w-full p-1 border-b font-semibold">
                <input type="text" id="ownerName" value="K. Siva kumar" class="w-full p-1 border-b">
                <input type="text" id="phoneNumber" value="9841836631" class="w-full p-1 border-b">
            </div>

            <div class="p-3 bg-white rounded shadow-sm border border-blue-100">
                <p class="font-bold text-sm mb-1 text-gray-600">Client Details</p>
                <input type="text" id="clientName" placeholder="Client Name" class="w-full p-1 border-b">
                <textarea id="clientAddress" placeholder="Client Address (Optional)" class="w-full p-1 border-b resize-none"></textarea>
            </div>

        </div>
    </div>

    <form id="quotationForm">
        <div id="sectionsContainer"></div>

        <div class="flex flex-col md:flex-row justify-between items-center mt-8 space-y-4 md:space-y-0">
            <button type="button" id="addSection"
                    class="w-full md:w-auto px-6 py-3 bg-green-600 text-white rounded-lg shadow-md hover:bg-green-700">
                + Add New Room/Section
            </button>

            <button type="button" id="calculateBtn"
                    class="w-full md:w-auto px-8 py-3 bg-blue-600 text-white font-bold text-lg rounded-lg shadow-lg hover:bg-blue-700">
                Calculate & Generate Output
            </button>
        </div>
    </form>

    <hr class="my-10 border-gray-300">

    <h2 class="text-2xl font-semibold text-gray-700 mb-4">Quick Copy Output</h2>

    <div id="outputContainer" class="hidden">
        <pre id="outputArea" class="monospace bg-gray-50 border p-4 rounded-lg text-sm"></pre>

        <div id="messageBox" class="text-center p-3 mt-4 hidden"></div>

        <div class="flex justify-between mt-4">
            <button type="button" id="copyBtn"
                    class="px-6 py-2 bg-purple-600 text-white rounded-lg shadow-md hover:bg-purple-700">
                üìã Copy Text
            </button>

            <button type="button" id="downloadBtn"
                    class="px-6 py-2 bg-red-600 text-white rounded-lg shadow-md hover:bg-red-700">
                ‚¨áÔ∏è Download PDF
            </button>
        </div>
    </div>

    <p id="initialPrompt"
       class="text-gray-500 text-center p-8 border-dashed border-2 rounded-lg">
        Enter details above & click "Calculate"
    </p>

</div>

<!-- HIDDEN PDF CONTENT -->
<div id="pdfContent" class="p-8 bg-white" style="width: 210mm; min-height: 297mm; display:none;"></div>

<script>
// ------------------- PART 2: JS (Paste after the <script> tag from Part 1) -------------------

    // jsPDF constructor reference
    let JspdfConstructor = null;

    const DOM = {
        sectionsContainer: document.getElementById('sectionsContainer'),
        addSectionBtn: document.getElementById('addSection'),
        calculateBtn: document.getElementById('calculateBtn'),
        outputContainer: document.getElementById('outputContainer'),
        outputArea: document.getElementById('outputArea'),
        copyBtn: document.getElementById('copyBtn'),
        downloadBtn: document.getElementById('downloadBtn'),
        messageBox: document.getElementById('messageBox'),
        initialPrompt: document.getElementById('initialPrompt'),
        pdfContent: document.getElementById('pdfContent'),
        companyName: document.getElementById('companyName'),
        ownerName: document.getElementById('ownerName'),
        phoneNumber: document.getElementById('phoneNumber'),
        clientName: document.getElementById('clientName'),
        clientAddress: document.getElementById('clientAddress')
    };

    // Try to locate the jsPDF constructor (UMD build puts it on window.jspdf.jsPDF)
    const loadJSPDF = () => {
        if (typeof window.jspdf !== 'undefined' && typeof window.jspdf.jsPDF === 'function') {
            JspdfConstructor = window.jspdf.jsPDF;
        } else if (typeof window.jsPDF === 'function') {
            JspdfConstructor = window.jsPDF;
        } else {
            JspdfConstructor = null;
        }
    };
    loadJSPDF();

    // Tiny UI message helper
    const showMessage = (type, msg) => {
        DOM.messageBox.textContent = msg;
        let base = 'text-center p-3 mt-4 rounded-lg ';
        if (type === 'success') {
            DOM.messageBox.className = base + 'bg-green-100 border-l-4 border-green-500 text-green-700';
        } else {
            DOM.messageBox.className = base + 'bg-red-100 border-l-4 border-red-500 text-red-700';
        }
        DOM.messageBox.classList.remove('hidden');
        setTimeout(() => DOM.messageBox.classList.add('hidden'), 3000);
    };

    /**
     * calculateItemTotal(row)
     * Updates calculated area and dataset.total for a given item row.
     */
    const calculateItemTotal = (row) => {
        const length = parseFloat(row.querySelector('.item-length').value) || 0;
        const breadth = parseFloat(row.querySelector('.item-breadth').value) || 0;
        const rate = parseFloat(row.querySelector('.item-rate').value) || 0;

        const area = length * breadth;
        let lineTotal = 0;

        if (area > 0 && rate > 0) {
            lineTotal = Math.round(area * rate);
        } else if (area === 0 && rate > 0) {
            // Lump sum
            lineTotal = Math.round(rate);
        }

        row.querySelector('.calculated-area').textContent = area.toFixed(2);
        row.dataset.total = lineTotal;
        row.dataset.area = area.toFixed(2);
        row.querySelector('.calculated-total').textContent = lineTotal.toLocaleString('en-IN');
    };

    /**
     * createItemRow(defaultName, defaultL, defaultB, defaultRate)
     * returns DOM element for a single item row
     */
    const createItemRow = (defaultName = '', defaultL = '', defaultB = '', defaultRate = '') => {
        const row = document.createElement('div');
        row.className = 'item-row flex flex-wrap md:flex-nowrap items-center gap-3 mb-3 p-2 bg-white border rounded-md shadow-sm';
        row.innerHTML = `
            <input type="text" class="item-name flex-grow min-w-[100px] p-2 border border-gray-300 rounded" placeholder="Item Name (e.g., WARDROBE)" value="${defaultName}">
            <div class="flex gap-1">
                <input type="number" class="item-length w-16 p-2 border border-gray-300 rounded text-center" placeholder="L" min="0" step="0.5" value="${defaultL}">
                <span class="p-2 text-gray-500">X</span>
                <input type="number" class="item-breadth w-16 p-2 border border-gray-300 rounded text-center" placeholder="B" min="0" step="0.5" value="${defaultB}">
            </div>
            <span class="calculated-area w-20 text-center font-medium text-blue-600">0.00</span>
            <input type="number" class="item-rate w-20 p-2 border border-gray-300 rounded text-center" placeholder="Rate" min="0" step="1" value="${defaultRate}">
            <span class="calculated-total flex-grow text-right font-bold text-lg text-green-600 min-w-[70px]">0</span>
            <button type="button" class="remove-item flex-shrink-0 text-red-500 hover:text-red-700 transition duration-150" title="Remove Item">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3m-5 0h10" />
                </svg>
            </button>
        `;

        // Event listeners
        ['.item-length', '.item-breadth', '.item-rate'].forEach(sel => {
            row.querySelectorAll(sel).forEach(inp => inp && inp.addEventListener('input', () => calculateItemTotal(row)));
        });

        // Remove
        row.querySelector('.remove-item').addEventListener('click', () => row.remove());

        // initial calc
        setTimeout(() => calculateItemTotal(row), 0);

        return row;
    };

    /**
     * createSectionContainer(subheading, items)
     * returns DOM element for a section containing items
     */
    const createSectionContainer = (subheading = '', items = [{name: '', l: '', b: '', rate: ''}]) => {
        const sectionDiv = document.createElement('div');
        sectionDiv.className = 'section-input mb-6 p-4 border-t-4 border-blue-500 bg-blue-50 rounded-lg shadow-md';

        sectionDiv.innerHTML = `
            <div class="flex justify-between items-center mb-4">
                <input type="text" class="subheading text-xl font-bold p-2 w-full border-b-2 border-blue-300 bg-transparent focus:outline-none" placeholder="Room/Section Name (e.g., Bed ROOM I (ROAD SIDE))" value="${subheading}">
                <button type="button" class="remove-section ml-4 text-red-400 hover:text-red-600 transition duration-150" title="Remove Section">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>

            <div class="hidden md:flex flex-wrap md:flex-nowrap items-center gap-3 mb-2 font-semibold text-gray-700 text-sm border-b pb-1">
                <span class="flex-grow min-w-[100px]">Item Description</span>
                <span class="w-16 text-center">Length (L)</span>
                <span class="w-16 text-center">Breadth (B)</span>
                <span class="w-20 text-center text-blue-600">Area (Sq)</span>
                <span class="w-20 text-center">Rate (‚Çπ/Sq)</span>
                <span class="flex-grow text-right min-w-[70px]">Total Amount (‚Çπ)</span>
                <span class="flex-shrink-0 w-6"></span>
            </div>

            <div class="item-list"></div>

            <button type="button" class="add-item mt-4 px-4 py-2 bg-blue-500 text-white font-semibold rounded-lg hover:bg-blue-600 transition duration-300 text-sm">
                + Add Line Item
            </button>
        `;

        const itemList = sectionDiv.querySelector('.item-list');
        const addItemBtn = sectionDiv.querySelector('.add-item');

        // populate initial items
        items.forEach(it => itemList.appendChild(createItemRow(it.name || '', it.l || '', it.b || '', it.rate || '')));

        addItemBtn.addEventListener('click', () => itemList.appendChild(createItemRow()));
        sectionDiv.querySelector('.remove-section').addEventListener('click', () => sectionDiv.remove());

        return sectionDiv;
    };

    /**
     * generateQuotation(forPrint)
     * If forPrint === false -> returns monospace text for quick-copy output
     * If forPrint === true  -> returns pdf-ready HTML string (table-based)
     */
    const generateQuotation = (forPrint = false) => {
        const sections = document.querySelectorAll('.section-input');

        // formatting constants for text output
        const LINE_LENGTH = 100;
        const NAME_PAD = 40;
        const SIZE_PAD = 15;
        const AREA_PAD = 10;
        const RATE_PAD = 10;
        const TOTAL_PAD = 12;
        const SEPARATOR = '-'.repeat(LINE_LENGTH);

        const companyName = DOM.companyName.value.trim().toUpperCase();
        const ownerName = DOM.ownerName.value.trim();
        const phoneNumber = DOM.phoneNumber.value.trim();
        const clientName = DOM.clientName.value.trim();
        const clientAddress = DOM.clientAddress.value.trim();
        const currentDate = new Date().toLocaleDateString('en-IN', { dateStyle: 'medium' });

        if (!companyName || !ownerName || !phoneNumber || !clientName) {
            if (!forPrint) showMessage('error', 'Please fill Company, Owner, Phone, and Client Name.');
            return false;
        }

        // COMMON: Build text output as before (used for quick-copy)
        let outputText = '';
        let grandTotal = 0;

        outputText += companyName.padStart(LINE_LENGTH / 2 + companyName.length / 2, ' ') + '\n';
        outputText += `Contact: ${ownerName} | Mobile: ${phoneNumber}`.padStart(LINE_LENGTH / 2 + (`Contact: ${ownerName} | Mobile: ${phoneNumber}`).length / 2, ' ') + '\n\n';
        outputText += `Date: ${currentDate}`.padEnd(LINE_LENGTH - `Quotation for: ${clientName}`.length) + `Quotation for: ${clientName}\n`;
        if (clientAddress) outputText += `Address: ${clientAddress.replace(/\n/g, ' ')}\n`;
        outputText += SEPARATOR + '\n';

        let headerLine = "ITEM DESCRIPTION".padEnd(NAME_PAD, ' ');
        headerLine += "SIZE (L X B)".padEnd(SIZE_PAD, ' ');
        headerLine += "AREA (SQ)".padEnd(AREA_PAD, ' ');
        headerLine += "RATE (‚Çπ)".padEnd(RATE_PAD, ' ');
        headerLine += "AMOUNT (‚Çπ)".padStart(TOTAL_PAD, ' ');
        outputText += headerLine + '\n';
        outputText += SEPARATOR + '\n';

        // We'll also build tableRowsHTML for PDF if needed
        let tableRowsHTML = '';

        sections.forEach((section) => {
            const subheading = section.querySelector('.subheading').value.trim().toUpperCase();
            const itemRows = section.querySelectorAll('.item-row');

            if (subheading) {
                outputText += `\n${subheading}\n`;
                if (forPrint) {
                    tableRowsHTML += `<tr><td colspan="5" style="padding:8px 0;font-weight:bold;background:#f3f4f6;">${subheading}</td></tr>`;
                }
            }

            itemRows.forEach((row) => {
                const name = (row.querySelector('.item-name')?.value || '').trim();
                const L = parseFloat(row.querySelector('.item-length')?.value) || 0;
                const B = parseFloat(row.querySelector('.item-breadth')?.value) || 0;
                const rate = parseFloat(row.querySelector('.item-rate')?.value) || 0;
                const total = parseInt(row.dataset.total) || 0;
                const area = parseFloat(row.dataset.area) || 0;

                if (!name || total <= 0) return;

                grandTotal += total;

                // TEXT LINE (monospace)
                let line = name.substring(0, NAME_PAD).padEnd(NAME_PAD, ' ');
                if (area > 0) {
                    const sizeStr = `${L.toFixed(1)} X ${B.toFixed(1)}`;
                    const areaStr = area.toFixed(2);
                    const rateStr = rate.toLocaleString('en-IN');
                    line += sizeStr.padEnd(SIZE_PAD, ' ');
                    line += areaStr.padEnd(AREA_PAD, ' ');
                    line += rateStr.padEnd(RATE_PAD, ' ');
                } else {
                    line += 'LUMP SUM'.padEnd(SIZE_PAD, ' ');
                    line += '-'.padEnd(AREA_PAD, ' ');
                    line += '-'.padEnd(RATE_PAD, ' ');
                }
                line += total.toLocaleString('en-IN').padStart(TOTAL_PAD, ' ');
                outputText += line + '\n';

                // TABLE ROW for PDF (guaranteed column widths & right-aligned amount)
                const displaySize = (area > 0) ? `${L.toFixed(1)} √ó ${B.toFixed(1)}` : '-';
                const displayArea = (area > 0) ? area.toFixed(2) : '-';
                const displayRate = (rate > 0) ? rate.toLocaleString('en-IN') : '-';
                const displayTotal = total.toLocaleString('en-IN');

                tableRowsHTML += `
                    <tr>
                        <td style="padding:6px 8px; border-bottom:1px solid #e5e7eb;">${escapeHtml(name)}</td>
                        <td style="padding:6px 8px; text-align:center; border-bottom:1px solid #e5e7eb;">${displaySize}</td>
                        <td style="padding:6px 8px; text-align:center; border-bottom:1px solid #e5e7eb;">${displayArea}</td>
                        <td style="padding:6px 8px; text-align:center; border-bottom:1px solid #e5e7eb;">${displayRate}</td>
                        <td style="padding:6px 8px; text-align:right; border-bottom:1px solid #e5e7eb;">${displayTotal}</td>
                    </tr>
                `;
            });
        });

        // Footer text
        outputText += '\n' + SEPARATOR.substring(0, LINE_LENGTH - TOTAL_PAD - 8) + ' '.repeat(5);
        outputText += '-------' + '\n';
        const totalLabel = "GRAND TOTAL: ‚Çπ";
        outputText += totalLabel.padStart(LINE_LENGTH - (grandTotal.toLocaleString('en-IN').length + 1), ' ');
        outputText += grandTotal.toLocaleString('en-IN') + '\n';

        if (!forPrint) {
            return outputText;
        } else {
            // Build full PDF-ready HTML (table-based)
            const pdfHtml = `
                <div style="padding:12mm; font-family: Arial, sans-serif; color:#111827;">
                    <div style="text-align:center; margin-bottom:8mm;">
                        <h1 style="font-size:22pt; margin:0; color:#1e3a8a;">${escapeHtml(companyName)}</h1>
                        <p style="margin:6px 0 0 0; font-size:10pt; color:#374151;">Contact: ${escapeHtml(ownerName)} | Mobile: ${escapeHtml(phoneNumber)}</p>
                        <p style="margin:2px 0 0 0; font-size:9.5pt; color:#6b7280;">Quotation Generated on: ${escapeHtml(currentDate)}</p>
                    </div>

                    <div style="margin-bottom:8mm; font-size:10pt; color:#111827;">
                        <strong>Client:</strong> ${escapeHtml(clientName)}<br>
                        ${clientAddress ? '<strong>Address:</strong> ' + escapeHtml(clientAddress).replace(/\n/g, ', ') : ''}
                    </div>

                    <div style="border:1px solid #e6e6e6; padding:8px; background:#ffffff;">
                        <table style="width:100%; border-collapse:collapse; font-size:10pt; font-family: 'Courier New', monospace;">
                            <thead>
                                <tr>
                                    <th style="text-align:left; padding:8px 8px; width:40%; border-bottom:2px solid #111827;">ITEM DESCRIPTION</th>
                                    <th style="text-align:center; padding:8px 8px; width:15%; border-bottom:2px solid #111827;">SIZE (L √ó B)</th>
                                    <th style="text-align:center; padding:8px 8px; width:10%; border-bottom:2px solid #111827;">AREA (SQ)</th>
                                    <th style="text-align:center; padding:8px 8px; width:15%; border-bottom:2px solid #111827;">RATE (‚Çπ)</th>
                                    <th style="text-align:right; padding:8px 8px; width:20%; border-bottom:2px solid #111827;">AMOUNT (‚Çπ)</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${tableRowsHTML}
                                <tr>
                                    <td colspan="4" style="padding:8px 8px; text-align:right; font-weight:bold; border-top:2px solid #e5e7eb;">GRAND TOTAL:</td>
                                    <td style="padding:8px 8px; text-align:right; font-weight:bold; border-top:2px solid #e5e7eb;">${grandTotal.toLocaleString('en-IN')}</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <div style="margin-top:12mm; font-size:9.5pt; color:#6b7280;">
                        <p>Note: All amounts are estimates and may be subject to final measurement and material selection.</p>
                    </div>
                </div>
            `;
            return pdfHtml;
        }
    };

    // Utility to escape HTML to avoid injection when building HTML string
    function escapeHtml(unsafe) {
        if (unsafe === undefined || unsafe === null) return '';
        return String(unsafe)
            .replace(/&/g, "&amp;")
            .replace(/</g, "&lt;")
            .replace(/>/g, "&gt;")
            .replace(/"/g, "&quot;")
            .replace(/'/g, "&#039;");
    }

    // Event wiring
    window.onload = () => {
        // Add an initial blank section
        DOM.sectionsContainer.appendChild(createSectionContainer(''));
    };

    DOM.addSectionBtn.addEventListener('click', () => {
        DOM.sectionsContainer.appendChild(createSectionContainer(''));
    });

    DOM.calculateBtn.addEventListener('click', (e) => {
        e.preventDefault();
        // Recalculate all rows
        document.querySelectorAll('.item-row').forEach(r => calculateItemTotal(r));

        const text = generateQuotation(false);
        if (!text) return; // error message already shown

        DOM.outputArea.textContent = text;
        DOM.outputContainer.classList.remove('hidden');
        DOM.initialPrompt.classList.add('hidden');
        showMessage('success', 'Quotation generated.');
    });

    DOM.copyBtn.addEventListener('click', async () => {
        try {
            const text = DOM.outputArea.textContent || '';
            if (navigator.clipboard && navigator.clipboard.writeText) {
                await navigator.clipboard.writeText(text);
            } else {
                const ta = document.createElement('textarea');
                ta.value = text;
                document.body.appendChild(ta);
                ta.select();
                document.execCommand('copy');
                document.body.removeChild(ta);
            }
            showMessage('success', 'Copied to clipboard.');
        } catch (err) {
            showMessage('error', 'Copy failed. Use manual copy.');
        }
    });

    // PDF generation using html2canvas + jsPDF
    async function generatePDF() {
        // Ensure jsPDF is loaded
        loadJSPDF();
        if (!JspdfConstructor) {
            showMessage('error', 'PDF library not ready.');
            return;
        }

        // Recalculate
        document.querySelectorAll('.item-row').forEach(r => calculateItemTotal(r));

        const pdfHtml = generateQuotation(true);
        if (!pdfHtml) {
            showMessage('error', 'Please fill required details.');
            return;
        }

        // Put HTML in hidden container and make it visible for html2canvas
        DOM.pdfContent.innerHTML = pdfHtml;
        DOM.pdfContent.style.display = 'block';

        try {
            const canvas = await html2canvas(DOM.pdfContent, { scale: 2, useCORS: true });
            const imgData = canvas.toDataURL('image/jpeg', 0.95);
            const pdf = new JspdfConstructor('p', 'mm', 'a4');

            const pageWidth = 210;
            const pageHeight = 297;
            const imgWidth = pageWidth;
            const imgHeight = (canvas.height * pageWidth) / canvas.width;

            let heightLeft = imgHeight;
            let position = 0;

            // First page
            pdf.addImage(imgData, 'JPEG', 0, 0, imgWidth, imgHeight);
            heightLeft -= pageHeight;

            // Additional pages
            while (heightLeft > -10) {
                position = heightLeft - imgHeight;
                pdf.addPage();
                pdf.addImage(imgData, 'JPEG', 0, position, imgWidth, imgHeight);
                heightLeft -= pageHeight;
            }

            const stamp = new Date().toISOString().replace(/[:.]/g, '-').slice(0, 19);
            pdf.save(`Quotation_${stamp}.pdf`);
            showMessage('success', 'PDF downloaded.');
        } catch (err) {
            console.error('PDF error:', err);
            showMessage('error', 'PDF generation failed. Check console.');
        } finally {
            // cleanup
            DOM.pdfContent.style.display = 'none';
            DOM.pdfContent.innerHTML = '';
        }
    }

    DOM.downloadBtn.addEventListener('click', generatePDF);

// Close script, body and html
</script>
</body>
</html>
